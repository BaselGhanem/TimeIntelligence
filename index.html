<!DOCTYPE html>

<html lang="ar" dir="rtl">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Time Brain V3 | Ø¨Ø§Ø³Ù„ ØºØ§Ù†Ù…</title>

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">



    <style>

        :root {

            --primary: #099999;

            --primary-light: #e6fafa;

            --primary-dark: #066666;

            --secondary: #2c3e50;

            --bg: #f4f7f6;

            --surface: #ffffff;

            --deep-work: #6c5ce7;

            --danger: #e74c3c;

            --success: #27ae60;

            --text-main: #2c3e50;

            --text-light: #7f8c8d;

            --shadow: 0 4px 20px rgba(0,0,0,0.08);

            --radius: 12px;

        }



        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; }

        

        body { background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }



        /* Sidebar */

        .sidebar {

            width: 80px; background: var(--surface); display: flex; flex-direction: column; align-items: center;

            padding: 20px 0; border-left: 1px solid rgba(0,0,0,0.05); z-index: 90; box-shadow: var(--shadow);

        }

        .logo { 

            width: 50px; height: 50px; background: var(--primary); color: white; border-radius: 50%; 

            display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 20px; margin-bottom: 40px;

        }

        .nav-item {

            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;

            margin-bottom: 15px; border-radius: 12px; color: var(--text-light); cursor: pointer;

            transition: all 0.3s ease; font-size: 1.2rem;

        }

        .nav-item.active, .nav-item:hover { background: var(--primary-light); color: var(--primary); }



        /* Main Layout */

        .main-container { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }



        /* Header */

        .header {

            height: 80px; background: var(--surface); padding: 0 30px; display: flex; align-items: center; justify-content: space-between;

            border-bottom: 1px solid #eee; flex-shrink: 0;

        }

        .user-info h2 { font-size: 1.2rem; font-weight: 700; color: var(--secondary); }

        .user-info span { font-size: 0.8rem; color: var(--primary); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }



        .date-filters { display: flex; gap: 10px; background: var(--bg); padding: 5px; border-radius: 10px; }

        .date-btn { 

            border: none; background: transparent; padding: 8px 15px; border-radius: 8px; 

            cursor: pointer; font-weight: 600; color: var(--text-light); transition: 0.2s;

        }

        .date-btn:hover { background: rgba(0,0,0,0.05); }



        .kpi-wrapper { display: flex; gap: 20px; }

        .kpi-card { text-align: center; padding: 5px 15px; border-right: 1px solid #eee; }

        .kpi-card:last-child { border: none; }

        .kpi-val { font-weight: 800; font-size: 1.1rem; color: var(--primary); }

        .kpi-label { font-size: 0.7rem; color: var(--text-light); }

        

        /* Start Button */

        .start-btn {

            background: var(--secondary); color: white; border: none; padding: 8px 20px; border-radius: 8px;

            cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px;

        }

        .start-btn:hover { background: #1a252f; }



        /* Views */

        .view-section { display: none; height: calc(100% - 80px); width: 100%; }

        .view-section.active-view { display: block; }



        /* Grid System */

        .content-grid { display: grid; grid-template-columns: 350px 1fr 350px; height: 100%; }



        /* Panels */

        .panel { padding: 20px; height: 100%; overflow-y: auto; background: var(--bg); }

        .panel-white { background: var(--surface); border-left: 1px solid #eee; }

        .panel-right { border-right: 1px solid #eee; background: var(--surface); }



        /* Task Items */

        .task-item {

            background: var(--surface); border: 1px solid #eee; padding: 12px; border-radius: 8px;

            margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;

            border-right: 4px solid var(--primary); transition: transform 0.2s; cursor: pointer;

        }

        .task-item:hover { transform: translateX(-3px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .task-meta { font-size: 0.75rem; color: var(--text-light); margin-top: 4px; display: flex; gap: 10px; }



        /* Timeline */

        .timeline-container { width: 100%; max-width: 600px; margin: 0 auto; position: relative; padding-left: 60px; padding-bottom: 50px; }

        .time-slot { height: 60px; border-bottom: 1px dashed rgba(0,0,0,0.1); position: relative; }

        .time-label { position: absolute; left: -50px; top: -10px; font-size: 0.75rem; color: var(--text-light); }

        

        .block {

            position: absolute; left: 10px; right: 10px; border-radius: 6px; padding: 5px 10px;

            color: white; font-size: 0.8rem; display: flex; flex-direction: column; justify-content: center;

            box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; cursor: pointer; z-index: 10;

        }

        .block-task { background: var(--primary); border-right: 3px solid var(--primary-dark); }

        .block-deep { background: var(--deep-work); opacity: 0.9; border: 1px dashed rgba(255,255,255,0.3); }

        .block-break { background: repeating-linear-gradient(45deg, #bdc3c7, #bdc3c7 10px, #b0b6bb 10px, #b0b6bb 20px); color: #555; z-index: 5; }

        

        .now-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--danger); z-index: 20; pointer-events: none; }



        /* Dashboard V2 */

        .dashboard-grid {

            padding: 30px; display: grid; grid-template-columns: repeat(4, 1fr);

            grid-template-rows: auto auto 1fr; gap: 20px; height: 100%; overflow-y: auto; background: #f8f9fa;

        }

        .dash-card {

            background: white; border-radius: 16px; padding: 20px;

            box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column;

        }

        .dash-card.span-2 { grid-column: span 2; }

        .dash-card.span-4 { grid-column: span 4; }

        .stat-value { font-size: 2rem; font-weight: 800; color: var(--secondary); }

        .chart-box { height: 250px; position: relative; }



        /* MODAL POPUP */

        .modal-overlay {

            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;

            background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(5px);

            justify-content: center; align-items: center;

        }

        .modal-content {

            background: white; width: 450px; padding: 30px; border-radius: 20px;

            box-shadow: 0 20px 60px rgba(0,0,0,0.2); animation: slideUp 0.3s ease;

        }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        

        .input-group { margin-bottom: 15px; }

        .input-group label { display: block; font-size: 0.85rem; color: var(--text-light); margin-bottom: 8px; font-weight: 600; }

        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; font-size: 1rem; }

        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        

        .cat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }

        .cat-btn {

            padding: 10px; border: 1px solid #eee; border-radius: 8px; font-size: 0.8rem;

            cursor: pointer; text-align: center; transition: 0.2s; background: #f9f9f9;

        }

        .cat-btn:hover { background: #eee; }

        .cat-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }



        .fab-btn {

            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;

            background: var(--primary); color: white; border-radius: 50%;

            display: flex; align-items: center; justify-content: center; font-size: 24px;

            box-shadow: 0 10px 20px rgba(9, 153, 153, 0.4); cursor: pointer; transition: 0.2s; z-index: 500;

        }

        .fab-btn:hover { transform: scale(1.1); }



        .hidden { display: none !important; }

        

        /* Start Work Modal */

        .time-picker-simple { display: flex; gap: 10px; justify-content: center; margin-top: 10px;}

    </style>

</head>

<body>



    <div class="sidebar">

        <div class="logo">B</div>

        <div class="nav-item active" id="nav-calendar" onclick="switchView('calendar')"><i class="fas fa-calendar-alt"></i></div>

        <div class="nav-item" id="nav-analytics" onclick="switchView('analytics')"><i class="fas fa-chart-pie"></i></div>

        <div class="nav-item" onclick="backupData()"><i class="fas fa-cloud-download-alt"></i></div>

    </div>



    <div class="main-container">

        <div class="header">

            <div class="user-info">

                <h2>Ø¨Ø§Ø³Ù„ ØºØ§Ù†Ù…</h2>

                <span>Pharma Intelligence Architect</span>

            </div>

            

            <div style="display: flex; align-items: center; gap: 20px;">

                <button class="start-btn" id="btn-start-work" onclick="openStartWorkModal()">

                    <i class="fas fa-clock"></i> ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù…

                </button>



                <div class="date-filters">

                    <button class="date-btn" onclick="changeDate(-1)"><i class="fas fa-chevron-right"></i></button>

                    <input type="date" id="datePicker" class="date-btn" style="border:none; outline:none; font-family:'Tajawal'">

                    <button class="date-btn" onclick="changeDate(1)"><i class="fas fa-chevron-left"></i></button>

                    <button class="date-btn" onclick="resetToToday()">Ø§Ù„ÙŠÙˆÙ…</button>

                </div>

            </div>



            <div class="kpi-wrapper">

                <div class="kpi-card">

                    <div class="kpi-val" id="kpi-arrival">--:--</div>

                    <div class="kpi-label">ÙˆØµÙˆÙ„</div>

                </div>

                <div class="kpi-card">

                    <div class="kpi-val" id="kpi-exit" style="color: var(--danger)">--:--</div>

                    <div class="kpi-label">Ù…ØºØ§Ø¯Ø±Ø©</div>

                </div>

                <div class="kpi-card">

                    <div class="kpi-val" id="kpi-focus">0h</div>

                    <div class="kpi-label">Focus</div>

                </div>

            </div>

        </div>



        <div id="view-calendar" class="view-section active-view">

            <div class="content-grid">

                <div class="panel panel-white">

                    <div class="input-group">

                        <h3 style="font-size: 1rem; margin-bottom: 20px; color: var(--secondary)">Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…</h3>

                    </div>

                    <div id="taskListContainer"></div>

                </div>



                <div class="panel">

                    <div class="timeline-container" id="timelineContainer"></div>

                </div>



                <div class="panel panel-right">

                    <div class="dash-card">

                        <div class="stat-value" id="daily-focus-percent" style="font-size: 1.5rem">0%</div>

                        <div style="font-size:0.8rem; color:var(--text-light)">Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ© (Deep Work)</div>

                    </div>

                    <br>

                    <div class="dash-card" style="padding:15px">

                         <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px;">CEO Summary:</div>

                         <p id="ceo-text" style="font-size:0.8rem; color:var(--text-light); line-height:1.4">...</p>

                         <button onclick="copyCEOReport()" style="margin-top:10px; width:100%; border:1px solid #eee; background:white; cursor:pointer; padding:5px; border-radius:5px;">Ù†Ø³Ø®</button>

                    </div>

                </div>

            </div>

            

            <div class="fab-btn" onclick="openTaskModal()">

                <i class="fas fa-plus"></i>

            </div>

        </div>



        <div id="view-analytics" class="view-section" style="background: #f8f9fa;">

            <div class="dashboard-grid">

                <div class="dash-card"><div style="color:var(--text-light)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</div><div class="stat-value" id="dash-total-hours">0h</div></div>

                <div class="dash-card"><div style="color:var(--text-light)">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div><div class="stat-value" id="dash-task-count">0</div></div>

                <div class="dash-card"><div style="color:var(--text-light)">Field Visits</div><div class="stat-value" id="dash-field-visits">0</div></div>

                <div class="dash-card"><div style="color:var(--text-light)">Sales Analysis</div><div class="stat-value" id="dash-analysis-hours">0h</div></div>



                <div class="dash-card span-2"><div class="chart-box"><canvas id="monthlyTrendChart"></canvas></div></div>

                <div class="dash-card span-2"><div class="chart-box"><canvas id="monthlyCatChart"></canvas></div></div>

                

                <div class="dash-card span-4">

                    <h3>Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± (Top Activities)</h3>

                    <table style="width:100%; text-align:right; margin-top:10px; font-size:0.9rem; border-collapse: collapse;">

                        <thead style="border-bottom:1px solid #eee; color:var(--text-light)"><tr><th>Ø§Ù„Ù…Ù‡Ù…Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¯Ø©</th></tr></thead>

                        <tbody id="topTasksTable"></tbody>

                    </table>

                </div>

            </div>

        </div>

    </div>



    <div class="modal-overlay" id="taskModal">

        <div class="modal-content">

            <h2 style="margin-bottom:20px; color:var(--secondary)">Ø¥Ø¶Ø§ÙØ© Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</h2>

            

            <div class="input-group">

                <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· (Category)</label>

                <div class="cat-grid" id="catGrid">

                    </div>

                <input type="hidden" id="selectedCat">

            </div>



            <div class="input-group">

                <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</label>

                <input type="text" id="taskTitle" class="form-control" placeholder="Ù…Ø«Ø§Ù„: ØªØ­Ù„ÙŠÙ„ Ù…Ø¨ÙŠØ¹Ø§Øª Q3 - Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ù…Ù„" list="prevTasks">

                <datalist id="prevTasks"></datalist>

            </div>



            <div class="input-group" style="display:flex; gap:15px">

                <div style="flex:1">

                    <label>ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡</label>

                    <input type="time" id="startTime" class="form-control">

                </div>

                <div style="flex:1">

                    <label>Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label>

                    <input type="number" id="taskDuration" class="form-control" placeholder="60" value="30">

                </div>

            </div>



            <div style="display:flex; gap:10px; margin-top:20px;">

                <button class="start-btn" style="flex:1; background:var(--primary); justify-content:center" onclick="saveTask()">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>

                <button class="start-btn" style="background:#eee; color:#333; width:auto;" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>

            </div>

        </div>

    </div>



    <div class="modal-overlay" id="startWorkModal">

        <div class="modal-content" style="width:350px; text-align:center">

            <h2 style="margin-bottom:10px">ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ÙŠØ§ Ø¨Ø§Ø³Ù„</h2>

            <p style="color:var(--text-light); margin-bottom:20px">Ù…ØªÙ‰ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨ Ø§Ù„ÙŠÙˆÙ…ØŸ</p>

            <input type="time" id="arrivalPicker" class="form-control" style="font-size:1.5rem; text-align:center; margin-bottom:20px;">

            <button class="start-btn" style="width:100%; justify-content:center; background:var(--primary)" onclick="confirmStartWork()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>

        </div>

    </div>



    <script>

        // --- PHARMA SALES CONFIG ---

        const CONFIG = {

            breakStart: "13:00", breakEnd: "14:00",

            colors: {

                'Sales Analysis': '#099999', // Teal (Core)

                'Field Visit': '#e67e22',    // Orange (Action)

                'CRM & Data': '#9b59b6',     // Purple (Admin)

                'Forecasting': '#34495e',    // Dark Blue (Strategy)

                'Reporting': '#27ae60',      // Green (Result)

                'Meeting': '#f1c40f',        // Yellow

                'Deep Work': '#6c5ce7',      // Focus

                'Admin': '#95a5a6'           // Grey

            },

            categories: ['Sales Analysis', 'Field Visit', 'CRM & Data', 'Forecasting', 'Reporting', 'Meeting', 'Deep Work', 'Admin']

        };



        let state = {

            currentDate: new Date().toISOString().split('T')[0],

            tasks: JSON.parse(localStorage.getItem('basel_tasks')) || [],

            currentView: 'calendar'

        };



        function init() {

            document.getElementById('datePicker').value = state.currentDate;

            setupDatalist();

            renderAll();

            renderCatGrid();

            

            // Set default arrival to current time rounded

            const now = new Date();

            const timeStr = now.toTimeString().substring(0,5);

            document.getElementById('arrivalPicker').value = timeStr;

        }



        // --- Categories Logic ---

        function renderCatGrid() {

            const grid = document.getElementById('catGrid');

            grid.innerHTML = '';

            CONFIG.categories.forEach(cat => {

                const btn = document.createElement('div');

                btn.className = 'cat-btn';

                btn.innerText = cat;

                btn.onclick = () => selectCat(cat, btn);

                grid.appendChild(btn);

            });

        }



        function selectCat(cat, btnElement) {

            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));

            btnElement.classList.add('selected');

            document.getElementById('selectedCat').value = cat;

        }



        // --- Start Work Logic ---

        function openStartWorkModal() {

            document.getElementById('startWorkModal').style.display = 'flex';

        }

        function confirmStartWork() {

            const time = document.getElementById('arrivalPicker').value;

            // Add a zero duration marker task for Arrival

            state.tasks.push({

                id: Date.now(), date: state.currentDate, title: 'ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„',

                start: time, end: time, category: 'Admin', type: 'arrival' // Zero duration

            });

            saveData();

            document.getElementById('startWorkModal').style.display = 'none';

        }



        // --- Add Task Modal Logic ---

        function openTaskModal() {

            const modal = document.getElementById('taskModal');

            modal.style.display = 'flex';

            

            // Auto-Suggest Start Time

            const dailyTasks = state.tasks.filter(t => t.date === state.currentDate).sort((a,b) => a.end.localeCompare(b.end));

            if (dailyTasks.length > 0) {

                const lastTask = dailyTasks[dailyTasks.length - 1];

                document.getElementById('startTime').value = lastTask.end;

            } else {

                // If no tasks, default to now

                const now = new Date();

                document.getElementById('startTime').value = now.toTimeString().substring(0,5);

            }

            

            // Default Category

            if(!document.getElementById('selectedCat').value) {

                selectCat('Sales Analysis', document.querySelector('.cat-btn'));

            }

        }



        function closeModal() {

            document.getElementById('taskModal').style.display = 'none';

            document.getElementById('startWorkModal').style.display = 'none';

        }



        function saveTask() {

            const title = document.getElementById('taskTitle').value;

            const start = document.getElementById('startTime').value;

            const duration = parseInt(document.getElementById('taskDuration').value);

            const cat = document.getElementById('selectedCat').value;



            if (!title || !start || !duration || !cat) { alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }



            // Calculate End Time

            const [h, m] = start.split(':').map(Number);

            const totalStartMins = h * 60 + m;

            const totalEndMins = totalStartMins + duration;

            

            const endH = Math.floor(totalEndMins / 60);

            const endM = totalEndMins % 60;

            const end = `${endH.toString().padStart(2,'0')}:${endM.toString().padStart(2,'0')}`;



            state.tasks.push({ id: Date.now(), date: state.currentDate, title, start, end, category: cat, type: 'manual' });

            saveData();

            

            // Reset & Close

            document.getElementById('taskTitle').value = '';

            closeModal();

        }



        // --- Core Functions ---

        function saveData() {

            localStorage.setItem('basel_tasks', JSON.stringify(state.tasks));

            if (state.currentView === 'calendar') renderAll(); else renderDashboard();

        }



        function analyzeDay(dateString) {

            let rawTasks = state.tasks.filter(t => t.date === dateString).sort((a,b) => a.start.localeCompare(b.start));

            

            // Filter out 'arrival' markers for the list, but keep for calculation

            const arrivalTask = rawTasks.find(t => t.type === 'arrival');

            const arrival = arrivalTask ? arrivalTask.start : (rawTasks.length > 0 ? rawTasks[0].start : null);

            

            // Calculate Exit

            let exit = null;

            if (arrival) {

                const [h, m] = arrival.split(':').map(Number);

                let exitH = h + 9;

                exit = `${exitH.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;

            }



            // Gap Logic

            let processedTasks = [];

            let lastEnd = arrival;



            rawTasks.forEach(task => {

                // Skip markers in visualization if zero duration

                if(task.start === task.end) return; 



                if (lastEnd && task.start > lastEnd) {

                    processedTasks.push({ id: 'gap', title: 'Deep Work / Unlogged', start: lastEnd, end: task.start, category: 'Deep Work', type: 'auto' });

                }

                processedTasks.push(task);

                lastEnd = task.end;

            });



            return { arrival, exit, processedTasks, rawTasks };

        }



        function renderAll() {

            const { arrival, exit, processedTasks, rawTasks } = analyzeDay(state.currentDate);

            

            // Toggle Start Button visibility

            document.getElementById('btn-start-work').style.display = arrival ? 'none' : 'flex';



            document.getElementById('kpi-arrival').innerText = arrival || '--:--';

            document.getElementById('kpi-exit').innerText = exit || '--:--';



            // Calc Focus

            let focusMins = 0;

            let totalMins = 0;

            processedTasks.forEach(t => { 

                const d = diffMins(t.start, t.end);

                totalMins += d;

                if (['Deep Work', 'Sales Analysis', 'Forecasting'].includes(t.category)) focusMins += d;

            });

            document.getElementById('kpi-focus').innerText = formatMins(focusMins);

            document.getElementById('daily-focus-percent').innerText = totalMins ? Math.round((focusMins/totalMins)*100) + '%' : '0%';



            // Task List

            const list = document.getElementById('taskListContainer');

            list.innerHTML = '';

            rawTasks.filter(t => t.type !== 'arrival').forEach(t => {

                const div = document.createElement('div');

                div.className = 'task-item';

                div.style.borderRightColor = CONFIG.colors[t.category] || '#ccc';

                div.innerHTML = `<div><b>${t.title}</b><div class="task-meta"><i class="fas fa-tag"></i> ${t.category} | ${diffMins(t.start, t.end)}m</div></div>

                                 <button onclick="deleteTask(${t.id})" style="color:red;border:none;background:none"><i class="fas fa-trash"></i></button>`;

                list.appendChild(div);

            });



            // Timeline

            const tl = document.getElementById('timelineContainer');

            tl.innerHTML = '';

            for(let i=7; i<=19; i++) tl.innerHTML += `<div class="time-slot"><span class="time-label">${i}:00</span></div>`;

            drawBlock(tl, { start: CONFIG.breakStart, end: CONFIG.breakEnd, title: 'Break', type: 'break' });

            processedTasks.forEach(t => drawBlock(tl, t));



            // CEO Report

            const topCat = getTopCategory(rawTasks);

            document.getElementById('ceo-text').innerText = `ÙŠÙˆÙ… ${state.currentDate}:\nØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ ${arrival}. Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù†ØµØ¨ Ø¹Ù„Ù‰ ${topCat}.\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ù‡Ø§Ù…: ${rawTasks.length}.`;

        }



        function renderDashboard() {

            const currentMonth = state.currentDate.substring(0, 7);

            const monthTasks = state.tasks.filter(t => t.date.startsWith(currentMonth) && t.type !== 'arrival');

            

            let totalMins = 0;

            let visits = 0;

            let analysisMins = 0;

            let catTotals = {};

            let dailyHours = {};



            monthTasks.forEach(t => {

                const d = diffMins(t.start, t.end);

                totalMins += d;

                catTotals[t.category] = (catTotals[t.category] || 0) + d;

                dailyHours[t.date] = (dailyHours[t.date] || 0) + d;

                

                if(t.category === 'Field Visit') visits++;

                if(t.category === 'Sales Analysis') analysisMins += d;

            });



            document.getElementById('dash-total-hours').innerText = (totalMins/60).toFixed(1) + 'h';

            document.getElementById('dash-task-count').innerText = monthTasks.length;

            document.getElementById('dash-field-visits').innerText = visits;

            document.getElementById('dash-analysis-hours').innerText = (analysisMins/60).toFixed(1) + 'h';



            // Trend Chart

            const days = Object.keys(dailyHours).sort();

            new Chart(document.getElementById('monthlyTrendChart'), {

                type: 'bar',

                data: {

                    labels: days.map(d => d.substring(8)),

                    datasets: [{ label: 'Hours', data: days.map(d => (dailyHours[d]/60).toFixed(1)), backgroundColor: CONFIG.colors['Sales Analysis'] }]

                },

                options: { maintainAspectRatio: false }

            });



            // Cat Chart

            new Chart(document.getElementById('monthlyCatChart'), {

                type: 'doughnut',

                data: {

                    labels: Object.keys(catTotals),

                    datasets: [{ data: Object.values(catTotals), backgroundColor: Object.keys(catTotals).map(k => CONFIG.colors[k] || '#333') }]

                },

                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }

            });

            

             // Top Tasks Table

             const sortedTasks = [...monthTasks].sort((a,b) => diffMins(b.start, b.end) - diffMins(a.start, a.end)).slice(0, 5);

            const tableBody = document.getElementById('topTasksTable');

            tableBody.innerHTML = '';

            sortedTasks.forEach(t => {

                const tr = document.createElement('tr');

                tr.innerHTML = `<td>${t.title}</td><td>${t.date}</td><td>${t.category}</td><td>${diffMins(t.start, t.end)}m</td>`;

                tableBody.appendChild(tr);

            });

        }



        // --- Helpers ---

        function switchView(v) { state.currentView = v; document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active-view')); document.getElementById(`view-${v}`).classList.add('active-view'); if(v==='analytics') renderDashboard(); else renderAll(); }

        function changeDate(d) { const dt = new Date(state.currentDate); dt.setDate(dt.getDate()+d); state.currentDate = dt.toISOString().split('T')[0]; document.getElementById('datePicker').value = state.currentDate; renderAll(); }

        function resetToToday() { state.currentDate = new Date().toISOString().split('T')[0]; document.getElementById('datePicker').value = state.currentDate; renderAll(); }

        function timeToMin(t) { const [h, m] = t.split(':').map(Number); return h*60 + m; }

        function diffMins(s, e) { return timeToMin(e) - timeToMin(s); }

        function formatMins(m) { return `${Math.floor(m/60)}h ${m%60}m`; }

        function deleteTask(id) { if(confirm('Delete?')) { state.tasks = state.tasks.filter(t => t.id !== id); saveData(); } }

        function setupDatalist() { const l = document.getElementById('prevTasks'); l.innerHTML = ''; [...new Set(state.tasks.map(t => t.title))].forEach(t => { const o = document.createElement('option'); o.value = t; l.appendChild(o); }); }

        function copyCEOReport() { navigator.clipboard.writeText(document.getElementById('ceo-text').innerText); alert('Copied'); }

        function getTopCategory(tasks) { if(!tasks.length) return 'N/A'; const counts = {}; tasks.forEach(t => counts[t.category] = (counts[t.category]||0)+1); return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b); }

        function drawBlock(container, task) {

            const startM = timeToMin(task.start); const endM = timeToMin(task.end);

            const top = startM - (7*60); const height = endM - startM;

            if (top < 0) return;

            const el = document.createElement('div');

            el.className = 'block'; el.style.top = `${top}px`; el.style.height = `${height}px`;

            if (task.type === 'break') { el.classList.add('block-break'); el.innerText = 'Break'; }

            else if (task.category === 'Deep Work') { el.classList.add('block-deep'); el.innerText = 'Deep Work'; }

            else { el.classList.add('block-task'); el.style.backgroundColor = CONFIG.colors[task.category] || '#333'; el.innerHTML = `<b>${task.title}</b>`; }

            container.appendChild(el);

        }

        function backupData() {

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state.tasks));

            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "basel_pharma_brain.json"); document.body.appendChild(dl); dl.click(); dl.remove();

        }



        init();

    </script>

</body>

</html>

